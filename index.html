<!DOCTYPE html>
<html>
<head>
  <title>DokuWiki over I2P with Docker</title>
  <link rel="stylesheet" type="text/css" href="home.css" />
</head>
<body>
<h1 id="running-dokuwiki-over-i2p-with-docker">Running DokuWiki over I2P with Docker</h1>
<p><strong>UNFINISHED.</strong></p>
<p>How to host a DokuWiki as an I2P Site, using Docker and Java I2P. Writing with a slightly different tone than my other guides, today I want to talk a little more about “why” and it’s going to give us a different take on “how.” This is not going to be my most “Professional” article ever, today we’re in this together and I’m making a case for my plan.</p>
<h2 id="docker-is-your-fin-friend.">Docker is your f’in friend.</h2>
<h3 id="docker-can-make-your-life-easier.-yes-you.">Docker can make your life easier. Yes you.</h3>
<p>Docker isn’t just for systems administrators. If you let your computer run any programs while you’re not sitting there watching it, then Docker can probably offer you something worthwhile. Besides “containing” your applications within a stable, predictable, environment, which you can rebuild without interfering with the environment in a running container, Docker provides a general way of managing the lifecycle of your applications and dealing with crashes, sets up containers on a network Bridge where they do not share the localhost address of the host machine, and can manage data by attaching directories on the host to directories within the container. Learning some basic Docker usage will help you if it’s your job(or hobby, whatever) to host a bunch of hidden services. Besides that, if you’re the type to share your hidden service setup instructions with the community, it means that anyone on any OS can use them, as long as they can install Docker. Oh also there’s a freaking enormous community, every question you ever had has probably already been asked and answered on some(probably the wrong) StackExchange-adjacent site already.</p>
<p>So it pays to learn Docker. Or don’t, its your life. But I would.</p>
<p>Highlights of Docker include:</p>
<ul>
<li>Run on <a href="https://docs.docker.com/get-docker/">Linux</a>, <a href="https://docs.docker.com/docker-for-mac/install/">Mac OSX</a>, and <a href="https://docs.docker.com/docker-for-windows/install/">Windows</a> without modification.</li>
<li><a href="https://hub.docker.com">An absolutely enormous repository of community packages, Dockerhub</a></li>
<li>Automatically restart applications when they crash by passing <code>--restart=always</code> <code>docker run</code></li>
<li>Volume management using either “named” volumes or directories on the host machine by passing the <code>--volume</code> and <code>--mount</code> flags</li>
<li>Network “Bridge” which attaches to the host indirectly, containers have their own IP addresses on this bridge, own ports, may have their own hostnames. Ports can be forwarded to the host machine using the <code>-p</code> flag.</li>
<li>Among many, many more reasons why Docker is pretty much ideal for hosting small hidden services.</li>
</ul>
<p>Docker is really just another application, on most levels. Once you’ve used it a few times it ceases to be confusing, you’ll be passing pretty similar flags to every single container you ever build or run, and only very rarely does it ever get any more complex than the stuff you learn your first few weeks. It’s like <code>git</code>, it has lots of stuff to work with, but you end up using about the same six options every time.</p>
<h3 id="dockerhub-maybe-isnt-always-your-best-friend-but-thats-ok">Dockerhub maybe isn’t always your best friend, but that’s OK</h3>
<p>Dockerhub could be considered a sort of Man in the Middle. Most of the containers are build automatically on Docker’s infrastructure, which means that Dockerhub could in theory serve you up a bad image. This is pretty unlikely, though, and not at all the biggest risk. The biggest risk is that anybody can create a namespace and push an image to this infrastructure. That namespace can’t be racist, and it can’t be occupied by another user already, and I’m like, 85% sure it can’t contain your typical “lookalike” characters(Cyrillic O’s and whatnot). Nothing stops anyone from registering the namespace <code>mozzilla</code> though, or <code>mozil1a</code> or other legal characters that resemble eachother.</p>
<p>The part of dockerhub which is undeniably useful, though, is the statistics it generates on image usage, and its search capabilities. These are accessible via the <code>docker search</code> command.</p>
<p>Here’s a <code>docker search</code> example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">docker</span> search dokuwiki</span></code></pre></div>
<pre><code>    NAME                           DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
    mprasil/dokuwiki               Container running DokuWiki with nice URLs an…   97                   [OK]
    linuxserver/dokuwiki                                                           59                   
    istepanov/dokuwiki             Docker image with dokuwiki and nginx. Suppor…   43                   [OK]
    vimagick/dokuwiki              A wiki application licensed under GPL 2 and …   14                   [OK]
    bambucha/dokuwiki              Alpine DokuWiki Docker Container                8                    [OK]
    crazymax/dokuwiki              DokuWiki image based on Alpine Linux            7                    
    plaguedr/dokuwiki              DokuWiki is a wiki application licensed unde…   2                    
    dtwardow/dokuwiki              DokuWiki Docker Container                       1                    [OK]</code></pre>
<p>To avoid the risk of using a compromised upstream container, research the source of the docker image. Pay attention to the <code>FROM</code> line of the <code>Dockerfile</code>, and make sure that it corresponds to an “Official” signed base image from a distro like Ubuntu, Debian, or Alpine Linux, or that it is from <code>SCRATCH</code>. If it does not, find the source of the parent image, and repeat this process until the whole stack of images is analyzed. In practice, this is rarely more than one image.</p>
<p>To avoid the risk of using an out-of-date upstream container, build your image locally, and all of the parent images as well, unless you are confident in the upstream image being consistently maintained.</p>
<h2 id="dokuwiki-decisions">DokuWiki Decisions:</h2>
<h3 id="why-i-chose-dokuwiki">Why I chose DokuWiki</h3>
<p>Choosing software which is easy to an instance of is setting yourself up for success. Many hidden services are run by one person, if one is lucky one has a backup or possibly a skeleton crew. Only a handful of well-organized, mostly non-anonymous organizations have really reliable teams of people to operate and maintain their sites and the hardware that runs them.</p>
<p>This isn’t wrong, and it doesn’t have to be dangerous. It’s also true that many hidden services are operated by hobbyists, researchers, and enthusiasts who simply want to host their services in a way which transparently evades NAT difficulties. Many of them have small audiences and even smaller numbers of contributors. It’s not really my business to know why they want to use the I2P network, my business it to show them why it’s a good option(Which it is). As long as the software you are hosting is something you can keep up-to-date without breaking your back or losing your job, then it’s perfectly reasonable for just one person to manage and host a hidden service, even on a residential connection.</p>
<p>This is the chief advantage of DokuWiki, especially combined with Docker. There are no databases to set up, you can pre-configure the administrative user and password, it honors the <code>http_proxy</code> environment variable. There has never been a situation in which I had to lost data stored in a DokuWiki to an update.</p>
<h3 id="finding-a-dokuwiki-docker-image">Finding a DokuWiki Docker Image</h3>
<p>Let’s return to the <code>docker search</code> output from earlier for a moment, because that’s where we’re going to start.</p>
<pre><code>    NAME                           DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
    mprasil/dokuwiki               Container running DokuWiki with nice URLs an…   97                   [OK]
    linuxserver/dokuwiki                                                           59                   
    istepanov/dokuwiki             Docker image with dokuwiki and nginx. Suppor…   43                   [OK]
    vimagick/dokuwiki              A wiki application licensed under GPL 2 and …   14                   [OK]
    bambucha/dokuwiki              Alpine DokuWiki Docker Container                8                    [OK]</code></pre>
<p>So what is this telling us, and what conclusions should we be drawing from it?</p>
<p><code>[Name]</code> This is just the name of the image, in the form <code>[namespace]/[name]</code>. Often, this will be identical to the github or bitbucket namespace where the image source is available. The namespace tends to reveal if the image is maintained by an organization or by an individual. Obviously there are advantages to choosing an image maintained by an organization.</p>
<p><code>[Description]</code> The description of the image contains information additional to the name. It’s usually not the most interesting part of the <code>docker search</code> output.</p>
<p><code>[Stars]</code> As a rule, if only one person is using an image, it’s probably not up to date. Prioritize images with more users for research, stars will be positively correlated to users, and users will be positively correlated to eyes on the image, so prioritize images with the most stars.</p>
<p><code>[Official]</code> Docker only has a handful of “official” images which are provided by upstream distributions and software packages. Ubuntu, for instance, has an official image:</p>
<pre><code>    NAME                                                      DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
    ubuntu                                                    Ubuntu is a Debian-based Linux operating sys…   12481     [OK]       </code></pre>
<p><code>[Automated]</code> This means that the image was built on Docker’s automated build system, and not built on the developer’s machine and pushed up to Dockerhub.</p>
<p>So, what images will we evaluate? The two that look the most promising are <code>mprasil/dokuwiki</code>, and <code>linuxserver/dokuwiki</code>. <code>mprasil/dokuwiki</code> has a <a href="https://hub.docker.com/r/mprasil/dokuwiki">docker hub page here</a>. At the top it says “Updated a year ago” which is maybe not the best sign ever. On the other hand, <a href="https://hub.docker.com/r/linuxserver/dokuwiki">linuxserver/dokuwiki</a> was updated less than a week ago. That’s the one we need.</p>
<p>Before we continue, let’s look at the <code>Dockerfile</code>s that describe the containers which we will be running. First, the docker-dokuwiki <code>Dockerfile</code>:</p>
<ul>
<li><a href="https://github.com/linuxserver/docker-dokuwiki/blob/master/Dockerfile"><code>Dockerfile 1</code></a></li>
</ul>
<p>Uh-oh, looks like it’s <em>not</em> from an official image or a <code>SCRATCH</code> image as we recommended earlier. Instead, it modifies another image, the name suggests that it combines <code>Alpine Linux</code> with an <code>nginx</code> web server. Let’s look one level deeper at the parent <code>Dockerfile</code>.</p>
<ul>
<li><a href="https://github.com/linuxserver/docker-baseimage-alpine-nginx/blob/master/Dockerfile"><code>Dockerfile 2</code></a></li>
</ul>
<p>Examining this <code>Dockerfile</code> confirms the suspicion that it combines Alpine linux witn nginx and some modules. But we still haven’t reached the base image, that’s another level down.</p>
<ul>
<li><a href="https://github.com/linuxserver/docker-baseimage-alpine/blob/master/Dockerfile"><code>Dockerfile 3</code></a></li>
</ul>
<p>At last we’re here, and indeed each of the <code>Dockerfiles</code> looks non-malicious.</p>
<h3 id="getting-dokuwiki-configured">Getting DokuWiki Configured</h3>
<p>Setting up DokuWiki in a Docker container can be done in a couple simple steps. The quickest way to get started is to just run a modified version of the command from the linuxserver.io readme:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ex">docker</span> run -d <span class="kw">\</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>  <span class="ex">--name</span>=dokuwiki <span class="kw">\</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>  <span class="ex">-e</span> PUID=1000 <span class="kw">\</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>  <span class="ex">-e</span> PGID=1000 <span class="kw">\</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>  <span class="ex">-e</span> TZ=Europe/London <span class="kw">\</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>  <span class="ex">-p</span> 127.0.0.1:8080:80 <span class="kw">\</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>  <span class="ex">-v</span> <span class="va">$HOME</span>/.config/dokuwiki:/config <span class="kw">\</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>  <span class="ex">--restart</span> always <span class="kw">\</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>  <span class="ex">ghcr.io/linuxserver/dokuwiki</span></span></code></pre></div>
<p>In this command, we remove the HTTPS port forward since it won’t work over I2P (for now) and we explicitly specifiy that we want to <em>only</em> listen on the localhost with the HTTP port. This will allow us to safely listen locally without exposing our service to devices on the LAN or on the Internet. It also specifies that the container should always restart if it crashes, which will also cause it to start with the docker daemon, and places the config directory in your <code>$HOME/.config/</code> directory.</p>
<h2 id="i2p-pro-tips">I2P Pro Tips:</h2>
<h2 id="is-this-as-big-an-elephant-in-the-room-as-i-think-it-is">Is this as big an elephant in the room as I think it is?</h2>
</body>
</html>
